{
  "extends": [
    "local>platform-one/big-bang/pipeline-templates/renovate-runner"
  ],
  "enabledManagers": [
    "helmv3",
    "custom.regex"
  ],
  "labels": [
    "istioGateway",
    "Big Bang Core",
    "Package Sustainment",
    "kind::maintenance",
    "renovate"
  ],
  "postUpdateOptions": [
    "helmUpdateSubChartArchives"
  ],
  "packageRules": [
    {
      "matchDatasources": ["docker", "helm"],
      "matchManagers": ["custom.regex", "helmv3"],
      "groupName": "Istio Gateway"
    }
  ],
  "customManagers": [
    {
      "customType": "regex",
      "description": "Update chart appVersion to match upstream",
      "managerFilePatterns": [
        "/^chart/Chart\\.yaml$/"
      ],
      "matchStrings": [
        "appVersion:[^\\S\\r\\n]+(?<currentValue>.+)",
        "- Istio:\\s*(?<currentValue>.+)"
      ],
      "depNameTemplate": "gateway",
      "datasourceTemplate": "helm",
      "registryUrlTemplate": "https://istio-release.storage.googleapis.com/charts"
    },
    {
      "customType": "regex",
      "managerFilePatterns": [
        "/^chart/Chart\\.yaml$/"
      ],
      "matchStrings": [
        "image:[^\\S\\r\\n]+(?<depName>.+):(?<currentValue>.+)"
      ],
      "datasourceTemplate": "docker"
    }
  ],
  "postUpgradeTasks": {
    "commands": [
      // Use match-chart-yaml-appversion instead of bump-chart-yaml because this is a
      // passthrough chart where the chart version tracks appVersion directly.
      // bump-chart-yaml incorrectly increments minor version on patch updates
      // (e.g., 1.28.0 -> 1.28.1 would produce 1.29.0-bb.0 instead of 1.28.1-bb.0)
      "match-chart-yaml-appversion",
      "bump-changelog '{{#each upgrades}}- {{depName}} {{currentVersion}} -> {{newVersion}}\\n{{/each}}'",
      "regenerate-helm-docs"
    ],
    "fileFilters": [
      "chart/Chart.yaml",
      "README.md",
      "CHANGELOG.md"
    ]
  }
}
